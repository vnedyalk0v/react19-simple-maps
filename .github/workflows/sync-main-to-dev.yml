name: Sync main -> dev

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: sync-main-to-dev
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Create sync PR when main is ahead of dev
        id: sync_pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "dev";
            const head = "main";

            const compare = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${head}`,
            });

            if (compare.data.status === "identical" || compare.data.ahead_by === 0) {
              core.info("No sync needed: main is not ahead of dev.");
              return;
            }

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base,
              head: `${owner}:${head}`,
              per_page: 1,
            });

            if (existing.data.length > 0) {
              const existingPr = existing.data[0];
              core.info(`Sync PR already open: #${existingPr.number}`);
              core.setOutput("pr_number", String(existingPr.number));
              return;
            }

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: "chore: sync main into dev",
              head,
              base,
              body: [
                "Automated sync PR to keep `dev` up to date with `main`.",
                "",
                "- Trigger: push to `main`",
                "- Source: `main`",
                "- Target: `dev`",
              ].join("\n"),
            });

            core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
            core.setOutput("pr_number", String(pr.data.number));

      - name: Enable auto-merge for sync PR
        if: steps.sync_pr.outputs.pr_number != ''
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number("${{ steps.sync_pr.outputs.pr_number }}");

            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            if (pr.data.state !== "open") {
              core.info(`PR #${prNumber} is already ${pr.data.state}.`);
              return;
            }

            try {
              await github.graphql(
                `mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }) {
                    pullRequest {
                      number
                    }
                  }
                }`,
                {
                  pullRequestId: pr.data.node_id,
                }
              );
              core.info(`Enabled auto-merge for PR #${prNumber}.`);
            } catch (error) {
              core.warning(`Could not enable auto-merge for PR #${prNumber}: ${error.message}`);
            }
